#!/lib/shell/env bash5
# Copyright (C) 2019 Artem Slepnev, Shellgen
# License GPLv3+: GNU GPL version 3 or later
# gnu.org/licenses/gpl.html



if [[ ${EBUILD_PHASE-} == prepare ]]; then
   # after - post_src_prepare (user patch)
   if declare -F after_src_$EBUILD_PHASE &> /dev/null; then
      # error - color: red
      printf " \e[;31m++\e[m ${BASH_SOURCE##*/} after_src_$EBUILD_PHASE... error\n"
      return 1
   else
      # after post_src_prepare
      after_src_prepare() {
         set -o errexit -o pipefail -o nounset
         unset -f $FUNCNAME
         # ok - color: green
         printf " \e[1;3m+\e[m ebuild/$CATEGORY/$PN... $FUNCNAME\n"

         [[ $BASHOPTS == *nullglob* ]] || shopt -s nullglob
         [[ $SHELLOPTS == *noglob* ]] && set +o noglob
         # gentoo/libressl: LibreSSL ebuilds testing repository
         #  http4://github.com/gentoo/libressl
         #  http4://github.com/gentoo/libressl/raw/master/dev-qt/qtnetwork/files/qtnetwork-5.12.1-libressl.patch
         #  http4://github.com/gentoo/libressl/raw/master/dev-qt/qtnetwork/files/qtnetwork-5.12.4-libressl.patch
         for F in ${PORTAGE_ACTUAL_DISTDIR}/${PN}/*.diff; {
            patch --quiet -p1 -g0 -E --no-backup-if-mismatch < ${F} 2>&1
            if (( $? == 0 )); then
               # ok - color: green
               printf " \e[1;3m+\e[m  ${F##*/}... ok\n"
            else
               return
            fi
         }
         [[ $SHELLOPTS == *noglob* ]] || set -o noglob
         [[ $BASHOPTS == *nullglob* ]] && shopt -u nullglob
         set +o nounset +o pipefail +o errexit
      }
   fi
fi